name: Create Preview Deployment

on:
  workflow_dispatch:

jobs:
  create-preview-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install commercetools CLI
        run: npm install -g @commercetools/cli
        
      - name: Login to commercetools CLI
        run: |
          commercetools auth login \
            --client-credentials \
            --client-id ${{ vars.CTP_CLIENT_ID }} \
            --client-secret ${{ secrets.CTP_CLIENT_SECRET }} \
            --region ${{ vars.CTP_REGION }} \
            --project-key ${{ vars.CTP_PROJECT_KEY }}
            
      - name: Generate deployment key
        id: deployment-key
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
          DEPLOYMENT_KEY="admintools-$LATEST_TAG"
          echo "key=$DEPLOYMENT_KEY" >> $GITHUB_OUTPUT
          echo "Generated deployment key: $DEPLOYMENT_KEY"
            
      - name: Create preview deployment
        run: |
          COMMAND="commercetools connect connectorstaged preview \
            --id ${{ vars.CONNECTOR_ID }} \
            --deployment-key ${{ steps.deployment-key.outputs.key }} \
            --region ${{ vars.CTP_REGION }} \
            --configuration app.CUSTOM_APPLICATION_ID=\"${{ vars.APP_CUSTOM_APPLICATION_ID }}\" \
            --configuration app.ENTRY_POINT_URI_PATH=\"${{ vars.APP_ENTRY_POINT_URI_PATH }}\" \
            --configuration app.CLOUD_IDENTIFIER=\"${{ vars.APP_CLOUD_IDENTIFIER }}\" \
            --configuration app.MC_TEAM_NAME=\"${{ vars.APP_MC_TEAM_NAME }}\" \
            --configuration sellertools.CUSTOM_APPLICATION_ID=\"${{ vars.SELLERTOOLS_CUSTOM_APPLICATION_ID }}\" \
            --configuration sellertools.ENTRY_POINT_URI_PATH=\"${{ vars.SELLERTOOLS_ENTRY_POINT_URI_PATH }}\" \
            --configuration sellertools.CLOUD_IDENTIFIER=\"${{ vars.SELLERTOOLS_CLOUD_IDENTIFIER }}\" \
            --configuration sellertools.CMS_API_URL=\"${{ vars.SELLERTOOLS_CMS_API_URL }}\" \
            --configuration sellertools.SELLER_CUSTOMERGROUP_KEY=\"${{ vars.SELLERTOOLS_SELLER_CUSTOMERGROUP_KEY }}\" \
            --configuration chat.CTP_AUTH_URL=\"${{ vars.CTP_AUTH_URL }}\" \
            --configuration chat.CTP_API_URL=\"${{ vars.CTP_API_URL }}\" \
            --configuration chat.CTP_PROJECT_KEY=\"${{ vars.CTP_PROJECT_KEY }}\"
          
          echo "Executing commercetools command:"
          echo "$COMMAND"
          echo "---"
          
          eval "$COMMAND"
            
      - name: Output deployment information
        run: |
          echo "Preview deployment created successfully!"
          echo "Deployment key: ${{ steps.deployment-key.outputs.key }}"
          echo "Region: ${{ vars.CTP_REGION }}" 